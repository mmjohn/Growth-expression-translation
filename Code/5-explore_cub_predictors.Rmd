
---
title: "Exploring codon usage bias and predictors"
author: "Mackenzie Johnson"
date: "12/2/2021"
output: html_document
---

This document is the R version of `5-explore_cub_predictors.ipynb`, created for easier extension of the analysis and figures created by Adam.


```{r, message=FALSE}

library(tidyverse)
library(glue)
library(viridis)
library(cowplot)
library(ggtext)
library(broom)
library(ggdist)
library(distributional)
library(patchwork)

```


## Defining constants and save directories

```{r, message=FALSE}

path_to_data <- '/Users/mackenziejohnson/Documents/grad_school/wilke_lab/Growth-expression-translation/Data/'
path_to_figures <- '/Users/mackenziejohnson/Documents/grad_school/wilke_lab/Growth-expression-translation/Manuscript/Figures'

data_key <- tibble(
  set = c(
    'ecoli_full', 
    'ecoli_sparse', 
    'ecoli_prot',
    'scer_rna', 
    'scer_prot'
  ),
  cub_file = c(
    glue({path_to_data}, 'ecoli_info/', 'current_ecoli_master_table.tsv'),
    glue({path_to_data}, 'ecoli_info/', 'current_ecoli_master_table.tsv'),
    glue({path_to_data}, 'ecoli_info/', 'current_ecoli_master_table.tsv'),
    glue({path_to_data}, 'scer_info/', 'current_scer_master_table.tsv'),
    glue({path_to_data}, 'scer_info/', 'current_scer_master_table.tsv')
  ),
  meta_file = c(
    glue({path_to_data}, 'processed_data/', 'processed_metadata_ecoli.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_metadata_ecoli_SPARSE.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_metadata_ecoli_PROTEIN.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_metadata_scer_RNA.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_metadata_scer_PROTEIN.tsv')
  ),
  expression_file = c(
    glue({path_to_data}, 'processed_data/', 'processed_expression_ecoli.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_expression_ecoli_SPARSE.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_expression_ecoli_PROTEIN.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_expression_scer_RNA.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_expression_scer_PROTEIN.tsv')
  ),
  summary_file = c(
    glue({path_to_data}, 'processed_data/', 'processed_expression_summary_ecoli.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_expression_summary_ecoli_SPARSE.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_expression_summary_ecoli_PROTEIN.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_expression_summary_scer_RNA.tsv'),
    glue({path_to_data}, 'processed_data/', 'processed_expression_summary_scer_PROTEIN.tsv')
  )
)

# select dataset for analysis
data_tag <- "ecoli_full" 
metric <- "CAI" 

```


## Data import

```{r, message=FALSE}

# get relevant file names for data set of interest
data_key %>% 
  filter(set == data_tag) -> analysis_files

# read in data
# gene-specific measurements
full_df <- read_tsv(analysis_files$cub_file)
full_df <- full_df %>% 
  drop_na(CAI) # replace with metric
full_df$roc_semppr_mean <- log10(full_df$roc_semppr_mean)

# meta-data related to experiments / growth conditions
meta_df <- read_tsv(analysis_files$meta_file)

# condition-specific expression information
exp_df <- read_tsv(analysis_files$expression_file)

# expression sumary statistics calculated from the condition-specific expression matrices
exp_sum_df <- read_tsv(analysis_files$summary_file)

# core v accessory info


```


#### Merge data

```{r, message=FALSE}

if (data_tag %in% c("ecoli_full", "ecoli_sparse")) {
  full_df <- inner_join(full_df, exp_sum_df, by = c("locus_tag" = "log-TPM"))
  rm(exp_sum_df)
} else if (data_tag == "ecoli_prot") {
  full_df <- inner_join(full_df, exp_sum_df, by = c("gene" = "Gene"))
  rm(exp_sum_df)
} else {
  full_df <- full_df %>% 
    filter(gene != "hypothetical protein") %>% 
    mutate(gene = str_sub(.$gene, start = 1, end = -2)) 
  full_df$gene <- toupper(full_df$gene)
  full_df<- inner_join(full_df, exp_sum_df, by = c("gene" = "Gene"))
  rm(exp_sum_df)
}

```


## Find the individual conditions whose gene expression is most (and least) correlated with CUB

```{r, message=FALSE}

if (data_tag == "ecoli_full") {
  # get df
  corr_df <- full_df %>% 
    select(locus_tag, CAI) %>% 
    left_join(., exp_df, by = c("locus_tag" = "log-TPM")) 
  # correlations
  exp_cub_corr <- cor(corr_df$CAI, corr_df[3:105], method = "pearson") %>% 
    as_tibble() %>% 
    gather(
      .,
      key = "condition",
      value = "pearsons"
    ) %>% 
    mutate(r2 = pearsons^2)
} else if (data_tag == "ecoli_sparse") {
  # get df
  corr_df <- full_df %>% 
    select(locus_tag, CAI) %>% 
    left_join(., exp_df, by = c("locus_tag" = "log-TPM")) 
  # correlations
  exp_cub_corr <- cor(corr_df$CAI, corr_df[3:32], method = "pearson") %>% 
    as_tibble() %>% 
    gather(
      .,
      key = "condition",
      value = "pearsons"
    ) %>% 
    mutate(r2 = pearsons^2)
}  else if (data_tag == "ecoli_prot") {
  # get df
  corr_df <- full_df %>% 
    select(gene, CAI) %>% 
    left_join(., exp_df, by = c("gene" = "Gene")) 
   # correlations
  exp_cub_corr <- cor(corr_df$CAI, corr_df[3:22], method = "pearson") %>% 
    as_tibble() %>% 
    gather(
      .,
      key = "condition",
      value = "pearsons"
    ) %>% 
    mutate(r2 = pearsons^2)
} else {
  # get df
  corr_df <- full_df %>% 
    select(gene, CAI) %>% 
    left_join(., exp_df, by = c("gene" = "Gene")) 
  # correlations
  exp_cub_corr <- cor(corr_df$CAI, corr_df[3:16], method = "pearson") %>% 
    as_tibble() %>% 
    gather(
      .,
      key = "condition",
      value = "pearsons"
    ) %>% 
    mutate(r2 = pearsons^2)
}

min_corr <- exp_cub_corr %>% 
  filter(r2 == min(r2))
max_corr <- exp_cub_corr %>% 
  filter(r2 == max(r2))

if (data_tag %in% c("ecoli_full", "ecoli_sparse")) {
  
  fig_corr_min <- corr_df %>% 
    ggplot() +
      aes(x = `ica__cytd_rib`, y = CAI) +
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(min_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
  fig_corr_max <- corr_df %>% 
    ggplot() +
      aes(x = `rpoB__rpoBE672K_lb`, y = CAI) +
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(max_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
} else if (data_tag == "ecoli_prot") {
  
  fig_corr_min <- corr_df %>% 
    ggplot() +
      aes(x = `Galactose`, y = CAI) +
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(min_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
  fig_corr_max <- corr_df %>% 
    ggplot() +
      aes(x = `LB`, y = CAI) +
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(max_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
} else if (data_tag == "scer_rna") {
  
  fig_corr_min <- corr_df %>% 
    ggplot() +
      aes(x = `NH4_0.05_7.5_0.5`, y = CAI) +
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(min_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
  fig_corr_max <- corr_df %>% 
    ggplot() +
      aes(x = `NH4_0.35_7.5_0.5`, y = CAI) +
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(max_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
} else {
  
   fig_corr_min <- corr_df %>% 
    ggplot() +
      aes(x = `Phe_0.1_7.5_12.35`, y = CAI) +
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(min_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
  fig_corr_max <- corr_df %>% 
    ggplot() +
      aes(x = `NH4_0.35_7.5_0.5`, y = CAI) +
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(max_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
}


fig_corr_grow <- meta_df %>% 
  select(Simple_sample_id, `Growth Rate (1/hr)`) %>% 
  inner_join(., exp_cub_corr, by = c("Simple_sample_id" = "condition")) %>% 
  ggplot() +
    aes(x = `Growth Rate (1/hr)`, y = r2) +
    geom_point(size = 2, alpha = 0.75) +
    scale_y_continuous(name = '*R*<sup>2</sup> (CAI vs expression)') +
    theme_minimal_grid() +
    theme(axis.title.y = element_markdown())


```


```{r, include=FALSE, eval=FALSE}
# tAI version

if (metric == "tAI") {
  # get df
  corr_df <- full_df %>% 
    select(locus_tag, tAI) %>% 
    left_join(., exp_df, by = c("locus_tag" = "log-TPM")) 
  # correlations
  exp_cub_corr <- cor(corr_df$tAI, corr_df[3:105], method = "pearson") %>% #3:105 for full
    as_tibble() %>% 
    gather(
      .,
      key = "condition",
      value = "pearsons"
    ) %>% 
    mutate(r2 = pearsons^2)
  
  min_corr <- exp_cub_corr %>% 
    filter(r2 == min(r2))
  max_corr <- exp_cub_corr %>% 
    filter(r2 == max(r2))
  
  fig_corr_min <- corr_df %>% 
    ggplot() +
      aes(x = `cra_crp__delcra_ac`, y = tAI) +    
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(min_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
  fig_corr_max <- corr_df %>% 
    ggplot() +
      aes(x = `glu__glu_ale5`, y = tAI) +
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(max_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
  fig_corr_grow <- meta_df %>% 
    select(Simple_sample_id, `Growth Rate (1/hr)`) %>% 
    inner_join(., exp_cub_corr, by = c("Simple_sample_id" = "condition")) %>% 
    ggplot() +
      aes(x = `Growth Rate (1/hr)`, y = r2) +
      geom_point(size = 2, alpha = 0.75) +
      scale_y_continuous(name = '*R*<sup>2</sup> (tAI vs expression)') +
      theme_minimal_grid() +
      theme(axis.title.y = element_markdown())
  
} 


# ROC-SEMPPR version

if (metric == "roc_semppr_mean") {
  # get df
  corr_df <- full_df %>% 
    select(locus_tag, roc_semppr_mean) %>% 
    drop_na(roc_semppr_mean) %>% 
    left_join(., exp_df, by = c("locus_tag" = "log-TPM")) 
  # correlations
  exp_cub_corr <- cor(corr_df$roc_semppr_mean, corr_df[3:105], method = "pearson") %>% 
    as_tibble() %>% 
    gather(
      .,
      key = "condition",
      value = "pearsons"
    ) %>% 
    mutate(r2 = pearsons^2)
  
  min_corr <- exp_cub_corr %>% 
    filter(r2 == min(r2))
  max_corr <- exp_cub_corr %>% 
    filter(r2 == max(r2))
  
  fig_corr_min <- corr_df %>% 
    ggplot() +
      aes(x = `fps__fps_serB_ale4`, y = roc_semppr_mean) +    
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression (log TPM)") +
      scale_y_continuous(name = "ROC-SEMPPR") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(min_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
  fig_corr_max <- corr_df %>% 
    ggplot() +
      aes(x = `glu__glu_ale5`, y = roc_semppr_mean) +
      geom_point(alpha = 0.5) +
      scale_x_continuous(name = "Condition expression (log TPM)") +
      scale_y_continuous(name = "ROC-SEMPPR") +
      theme_minimal_grid() +
      labs(title = glue('*R*<sup>2</sup> = {round(max_corr$r2, 3)}')) +
      theme(plot.title = element_markdown())
  
  fig_corr_grow <- meta_df %>% 
    select(Simple_sample_id, `Growth Rate (1/hr)`) %>% 
    inner_join(., exp_cub_corr, by = c("Simple_sample_id" = "condition")) %>% 
    ggplot() +
      aes(x = `Growth Rate (1/hr)`, y = r2) +
      geom_point(size = 2, alpha = 0.75) +
      scale_y_continuous(name = '*R*<sup>2</sup> (metric vs expression)') +
      theme_minimal_grid() +
      theme(axis.title.y = element_markdown())
  
} 


```



## Growth rate data

```{r, message=FALSE}

fig_gr_hist <- meta_df %>% 
  ggplot(aes(x = `Growth Rate (1/hr)`)) +
  geom_histogram(binwidth = 0.05) +
  scale_x_continuous(
    limits = c(0, 1.5),
    expand = c(0,0)
  ) +
  scale_y_continuous(
    name = "Count", 
    expand = c(0,0)
  ) +
  theme_minimal_hgrid()

```


## Figure 3
```{r, message=FALSE}

fig_3 <- plot_grid(
  fig_corr_min, fig_corr_max, fig_gr_hist, fig_corr_grow,
  nrow = 2,
  labels = "AUTO"
) +
  theme(plot.background = element_rect(fill="white", color = NA))

fig_3

```

```{r, include=FALSE, eval=FALSE}

save_plot(
  file.path(
    path_to_figures, 
    glue('fig_{metric}_exp_gr_{data_tag}.png')   # file name
  ),
  fig_3, 
  base_height = 6.71,
  base_asp = 1.618, 
  base_width = NULL
)

```

```{r, message=FALSE, include=FALSE}

rm(fig_corr_max, fig_corr_min, fig_corr_grow, fig_gr_hist,
   min_corr, max_corr)

```


## Regression analysis to assess predictors of CUB

```{r, message=FALSE}

# model with average expression
# use scale() for z score - NOT CURRENTLY USING
lm_exp <- lm(CAI ~ mean, data = full_df)
glance(lm_exp)
tidy(lm_exp)

```


```{r, message=FALSE}

# model with growth correlation
lm_gai <- lm(CAI ~ lin_r, data = full_df)
glance(lm_gai)
tidy(lm_gai)

```


```{r, message=FALSE}

# model with average expression and gai
# use scale() for z score
lm_exp_gai <- lm(CAI ~ mean + lin_r, data = full_df)
glance(lm_exp_gai)
tidy(lm_exp_gai)

```


```{r, message=FALSE}

model_df <- tibble(
  model = c(
    "expression", 
    "gai", 
    "expression_gai", 
    "expression_gai"
  ),
  parameter = c(
    "avg exp",
    "gai",
    "avg exp",
    "gai"
  ),
  estimate = c(
    lm_exp$coefficients[[2]],
    lm_gai$coefficients[[2]],
    lm_exp_gai$coefficients[[2]],
    lm_exp_gai$coefficients[[3]]
  ),
  std_err = c(
    tidy(lm_exp)$std.error[2],
    tidy(lm_gai)$std.error[2],
    tidy(lm_exp_gai)$std.error[2],
    tidy(lm_exp_gai)$std.error[3]
  ),
  adj_r2 = c(
    glance(lm_exp)$adj.r.squared,
    glance(lm_gai)$adj.r.squared,
    glance(lm_exp_gai)$adj.r.squared,
    glance(lm_exp_gai)$adj.r.squared
  )
)

fig_m1 <- model_df %>% 
  filter(model == "expression") %>% 
  ggplot(aes(estimate, parameter)) +
  stat_dist_halfeye(
    aes(dist = dist_normal(
      mu = estimate, sigma = std_err
    )),
    point_size = 4
  ) +
  #scale_x_continuous(limits = c(.2, .6)) +
  scale_x_continuous(limits = c(0, .2)) +
  scale_y_discrete(labels = c("Expression")) +
  theme_minimal() +
  theme(
    axis.title = element_blank(),
  #  axis.text.x = element_blank()
  )

fig_m2 <- model_df %>% 
  filter(model == "gai") %>% 
  ggplot(aes(estimate, parameter)) +
  stat_dist_halfeye(
    aes(dist = dist_normal(
      mu = estimate, sigma = std_err
    )),
    point_size = 4
  ) +
  #scale_x_continuous(limits = c(.2, .6)) +
  scale_x_continuous(limits = c(0, .2)) +
  scale_y_discrete(labels = c("GCI")) +
  theme_minimal() +
  theme(
    axis.title = element_blank(),
  #  axis.text.x = element_blank()
  )

fig_m3 <- model_df %>% 
  filter(model == "expression_gai") %>% 
  ggplot(aes(estimate, parameter)) +
  stat_dist_halfeye(
    aes(dist = dist_normal(
      mu = estimate, sigma = std_err
    )),
    point_size = 4
  ) +
  scale_x_continuous(
  #  limits = c(.2, .6), 
    limits = c(0, .2),
    name = "Standardized model coefficient"
  ) +
  scale_y_discrete(labels = c("Expression", "GCI")) +
  theme_minimal() +
  theme(axis.title.y = element_blank())

fig_5a <- plot_grid(
  fig_m1, fig_m2, fig_m3,
  nrow = 3,
  rel_heights = c(1, 1, 2),
  align = "v"
)

rm(fig_m1, fig_m2, fig_m3)

fig_5b <- model_df %>% 
  slice(., 1:3) %>%
  ggplot(
    aes(
      adj_r2,
      fct_relevel(model, "expression_gai", "gai", "expression")
    )
  ) +
  geom_col() +
  scale_x_continuous(
    name = "Adjusted *R*<sup>2</sup>",
    limits = c(0, .4)
  ) +
  scale_y_discrete(labels = c("Both", "GCI", "Expression")) +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_markdown()
  )


```


```{r, message=FALSE}

fig_5c <- tibble(
  measured = full_df$CAI,
  predicted = lm_exp_gai$fitted.values
) %>% 
  ggplot(aes(measured, predicted)) +
  geom_point(alpha = 0.2) +
  scale_x_continuous(
    #limits = c(0, 1),
    name = "CAI"
  ) +
  scale_y_continuous(
    #limits = c(),
    name = "Multivariate model predictions"
  ) +
  theme_half_open() +
  background_grid() +
  coord_flip()

fig_5c

```


```{r, message=FALSE}

# lm_inter <- lm(
#   CAI ~ mean + lin_r + mean*lin_r, 
#   data = full_df
# )
# glance(lm_inter)
# tidy(lm_inter)

coff <- lm_exp_gai$coefficients

gci_models <- tibble(
  x_g = seq(
    from = max(full_df$mean), 
    to = min(full_df$mean), 
    length.out = 3847
  ),
  g1 = coff[[1]] + coff[[2]]*x_g + coff[[3]]*1,
  g2 = coff[[1]] + coff[[2]]*x_g + coff[[3]]*.66,
  g3 = coff[[1]] + coff[[2]]*x_g + coff[[3]]*.33,
  g0 = coff[[1]] + coff[[2]]*x_g + coff[[3]]*0,
  g_3 = coff[[1]] + coff[[2]]*x_g + coff[[3]]*-.33,
  g_2 = coff[[1]] + coff[[2]]*x_g + coff[[3]]*-.66,
  g_1 = coff[[1]] + coff[[2]]*x_g + coff[[3]]*-1
)

r2_int_text <- data.frame(
  label = glue(
    '*R*<sup>2</sup> = {round(glance(lm_exp_gai)$adj.r.squared, 3)}'),
  x = 2, 
  y = .8
)

fig_5d <- tibble(
  CAI = full_df$CAI,
  express = full_df$mean
) %>% 
  ggplot() +
  geom_point(aes(express, CAI), alpha = 0.2) +
  geom_line(data = gci_models, aes(x_g, g1), color = "#E69F00", size = 1) +
  geom_line(data = gci_models, aes(x_g, g2), color = "#56B4E9", size = 1) +
  geom_line(data = gci_models, aes(x_g, g3), color = "#009E73", size = 1) +
  geom_line(data = gci_models, aes(x_g, g0), color = "#F0E442", size = 1) +
  geom_line(data = gci_models, aes(x_g, g_1), color = "#0072B2", size = 1) +
  geom_line(data = gci_models, aes(x_g, g_2), color = "#D55E00", size = 1) +
  geom_line(data = gci_models, aes(x_g, g_3), color = "#CC79A7", size = 1) +
  geom_richtext(
    data = r2_int_text,
    aes(x = x, y = y,label = label),
    label.color = NA,
    inherit.aes = FALSE
  ) +
  scale_x_continuous(name = "Expression (mean, log TPM)") +
  theme_half_open() +
  background_grid() 

fig_5d

```


```{r, message=FALSE}

fig_5 <- fig_5a / (fig_5b | fig_5c) +
  plot_annotation(
     tag_levels = "A"
   )

fig_5
```

```{r, include=FALSE, eval=FALSE}
save_plot(
  file.path(
    path_to_figures, 
    glue('fig_{metric}_gci_model_{data_tag}.png')   # file name
  ),
  fig_5, 
  ncol = 1, 
  nrow = 1, 
  base_height = 6.71, #base_height = 5.71,
  base_asp = 1.618, 
  base_width = NULL
)

```


