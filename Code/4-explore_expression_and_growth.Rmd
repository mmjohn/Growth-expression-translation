
---
title: "Exploring gene expression and growth"
author: "Mackenzie Johnson"
date: "12/2/2021"
output: html_document
---

This document is the R version of `4-explore_expression_and_growth.ipynb`, created for easier extension of the analysis and figures created by Adam.


```{r, message=FALSE}
library(tidyverse)
library(glue)
library(pheatmap)
library(viridis)
library(cowplot)
library(ggtext)
```


## Defining constants and save directories

```{r, message=FALSE}

path_to_data <- '/Users/mackenziejohnson/Documents/grad_school/wilke_lab/Growth-expression-translation/Data/processed_data/'
path_to_figures <- '/Users/mackenziejohnson/Documents/grad_school/wilke_lab/Growth-expression-translation/Manuscript/Figures'

data_key <- tibble(
  set = c(
    'ecoli_full', 
    'ecoli_sparse', 
    'ecoli_prot',
    'scer_rna', 
    'scer_prot'
  ),
  meta_file = c(
    glue({path_to_data}, 'processed_metadata_ecoli.tsv'),
    glue({path_to_data}, 'processed_metadata_ecoli_SPARSE.tsv'),
    glue({path_to_data}, 'processed_metadata_ecoli_PROTEIN.tsv'),
    glue({path_to_data}, 'processed_metadata_scer_RNA.tsv'),
    glue({path_to_data}, 'processed_metadata_scer_PROTEIN.tsv')
  ),
  expression_file = c(
    glue({path_to_data}, 'processed_expression_ecoli.tsv'),
    glue({path_to_data}, 'processed_expression_ecoli_SPARSE.tsv'),
    glue({path_to_data}, 'processed_expression_ecoli_PROTEIN.tsv'),
    glue({path_to_data}, 'processed_expression_scer_RNA.tsv'),
    glue({path_to_data}, 'processed_expression_scer_PROTEIN.tsv')
  ),
  summary_file = c(
    glue({path_to_data}, 'processed_expression_summary_ecoli.tsv'),
    glue({path_to_data}, 'processed_expression_summary_ecoli_SPARSE.tsv'),
    glue({path_to_data}, 'processed_expression_summary_ecoli_PROTEIN.tsv'),
    glue({path_to_data}, 'processed_expression_summary_scer_RNA.tsv'),
    glue({path_to_data}, 'processed_expression_summary_scer_PROTEIN.tsv')
  )
)

# select dataset for analysis
data_tag <- "ecoli_full"

```


## Read in the data

```{r, message=FALSE}

# get relevant file names for data set of interest
data_key %>% 
  filter(set == data_tag) -> analysis_files

# read in data
meta_df <- read_tsv(analysis_files$meta_file)

exp_df <- read_tsv(analysis_files$expression_file)

exp_sum_df <- read_tsv(analysis_files$summary_file)

```


## Explore the relationship between conditions

```{r, message=FALSE}

# get pearson's correlation coefficient for gene expression between all conditions
cond_cor_mat <- exp_df %>% 
  select(-`log-TPM`) %>% # remove text
  cor(., method = "pearson")

dim(cond_cor_mat)
cond_cor_mat[1:4, 1:4]

```


```{r, message=FALSE}

# make heatmap for correlations across conditions
fig_exp_cond_corr <- pheatmap::pheatmap(
  cond_cor_mat,
  color = inferno(100),
  cellheight = 2,
  cellwidth = 2,
  border_color = NA,
  show_rownames = FALSE,
  show_colnames = FALSE,
  clustering_method = "average"
)

#fig_exp_cond_corr

```


```{r, message=FALSE}

# visualize expression across conditions for each gene
fig_cond_gene_exp <- pheatmap::pheatmap(
  exp_df[, -1],
  color = inferno(100),
  show_rownames = FALSE,
  show_colnames = FALSE,
  clustering_method = "average"
)

#fig_cond_gene_exp

```


#### Example scatterplots of two highly correlated conditions

```{r, message=FALSE}

# find max pearson's r value between two conditions
test_mat <- cond_cor_mat
diag(test_mat) <- 0 # exclude self correlations
#max(test_mat)
inds <- which(test_mat == max(test_mat), arr.ind = TRUE)

#cond_cor_mat[inds[1], inds[2]]
#rownames(inds) # "ytf__delydcI_ph5" "ytf__wt_ph5"
#exp_df[, inds[1]+1]
#exp_df[, inds[2]+1]

max_cond_corr_df <- tibble(
  exp_df[, inds[1]+1],
  exp_df[, inds[2]+1]
)
colnames(max_cond_corr_df) <- c("cond1", "cond2")

# 
r2_max_text <- data.frame(
  label = glue(
    '*R*<sup>2</sup> = {round(cond_cor_mat[inds[1], inds[2]]*
    cond_cor_mat[inds[1], inds[2]], 3)}'),
  x = 2,
  y = 13.5
)

#
fig_max <- max_cond_corr_df %>% 
  ggplot(aes(x = cond1, y = cond2)) +
  geom_point(color = "#43a2ca", alpha = 0.3) +
  scale_x_continuous(
    limits = c(0, 15),
    expand = c(0.01, 0.01),
    name = glue('Condition {inds[1]} (log TPM)')
  ) +
  scale_y_continuous(
    limits = c(0, 15),
    expand = c(0.02, 0.02),
    name = glue('Condition {inds[2]} (log TPM)')
  ) +
  #coord_fixed() +
  geom_richtext(
    data = r2_max_text,
    aes(x = x, y = y,label = label),
    label.color = NA,
    inherit.aes = FALSE
  ) +
  theme_bw()

fig_max

```


#### Example scatterplots of two minimally correlated conditions

```{r, message=FALSE}

# find min pearson's r value between two conditions
inds_min <- which(cond_cor_mat == min(cond_cor_mat), arr.ind = TRUE)
#cond_cor_mat[inds_min[1], inds_min[2]]
#rownames(inds_min) # "ica__cytd_rib"    "ssw__glc_xyl_glc"

min_cond_corr_df <- tibble(
  exp_df[, inds_min[1]+1],
  exp_df[, inds_min[2]+1]
)
colnames(min_cond_corr_df) <- c("cond1", "cond2")

#
r2_min_text <- data.frame(
  label = glue(
    '*R*<sup>2</sup> = {round(cond_cor_mat[inds_min[1], inds_min[2]]*
    cond_cor_mat[inds_min[1], inds_min[2]], 3)}'),
  x = 2,
  y = 13.5
)

#
fig_min <- min_cond_corr_df %>% 
  ggplot(aes(x = cond1, y = cond2)) +
  geom_point(color = "#43a2ca", alpha = 0.3) +
  scale_x_continuous(
    limits = c(0, 15),
    expand = c(0.01, 0.01),
    name = glue('Condition {inds_min[1]} (log TPM)')
  ) +
  scale_y_continuous(
    limits = c(0, 15),
    expand = c(0.02, 0.02),
    name = glue('Condition {inds_min[2]} (log TPM)')
  ) +
  #coord_fixed() +
  geom_richtext(
    data = r2_min_text,
    aes(x = x, y = y,label = label),
    label.color = NA,
    inherit.aes = FALSE
  ) +
  theme_bw()

fig_min

```


### Figure 2 
```{r, message=FALSE}

# combine figures for subplot b
fig_2b <- plot_grid(fig_max, fig_min, nrow = 2)

# combine all figures
fig_2 <- plot_grid(
  fig_exp_cond_corr[[4]], fig_2b, 
  nrow = 1,
  labels = "AUTO",
  scale = c(1, 0.85)
  # align = "h",
  # axis = "l"
)

fig_2

```

```{r, include=FALSE, eval=FALSE}

fig_2_fixed <- cowplot::ggdraw(fig_2) + 
  theme(plot.background = element_rect(fill="white", color = NA))

# save plot
save_plot(
  file.path(path_to_figures, 'mackenzie', 'fig2.png'),
  fig_2_fixed, ncol = 1, nrow = 1, base_height = 5.21, #base_height = 5.71,
  base_asp = 1.618, base_width = NULL
)

```



## Gene expression vs various dispersion metrics

```{r}

```


## Explore growth rate data

```{r}

```


#### Assess individual gene correlations with the growth rate data

```{r}

```


#### Finding representative examples of genes

```{r}

```


## Expression vs growth correlation

```{r}

```





