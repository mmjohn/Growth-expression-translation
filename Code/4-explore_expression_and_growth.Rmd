
---
title: "Exploring gene expression and growth"
author: "Mackenzie Johnson"
date: "12/2/2021"
output: html_document
---

This document is the R version of `4-explore_expression_and_growth.ipynb`, created for easier extension of the analysis and figures created by Adam.


```{r, message=FALSE}

library(tidyverse)
library(glue)
library(pheatmap)
library(viridis)
library(cowplot)
library(ggtext)

```


## Defining constants and save directories

```{r, message=FALSE}

path_to_data <- '/Users/mackenziejohnson/Documents/grad_school/wilke_lab/Growth-expression-translation/Data/processed_data/'
path_to_figures <- '/Users/mackenziejohnson/Documents/grad_school/wilke_lab/Growth-expression-translation/Manuscript/Figures'

data_key <- tibble(
  set = c(
    'ecoli_full', 
    'ecoli_sparse', 
    'ecoli_prot',
    'scer_rna', 
    'scer_prot'
  ),
  meta_file = c(
    glue({path_to_data}, 'processed_metadata_ecoli.tsv'),
    glue({path_to_data}, 'processed_metadata_ecoli_SPARSE.tsv'),
    glue({path_to_data}, 'processed_metadata_ecoli_PROTEIN.tsv'),
    glue({path_to_data}, 'processed_metadata_scer_RNA.tsv'),
    glue({path_to_data}, 'processed_metadata_scer_PROTEIN.tsv')
  ),
  expression_file = c(
    glue({path_to_data}, 'processed_expression_ecoli.tsv'),
    glue({path_to_data}, 'processed_expression_ecoli_SPARSE.tsv'),
    glue({path_to_data}, 'processed_expression_ecoli_PROTEIN.tsv'),
    glue({path_to_data}, 'processed_expression_scer_RNA.tsv'),
    glue({path_to_data}, 'processed_expression_scer_PROTEIN.tsv')
  ),
  summary_file = c(
    glue({path_to_data}, 'processed_expression_summary_ecoli.tsv'),
    glue({path_to_data}, 'processed_expression_summary_ecoli_SPARSE.tsv'),
    glue({path_to_data}, 'processed_expression_summary_ecoli_PROTEIN.tsv'),
    glue({path_to_data}, 'processed_expression_summary_scer_RNA.tsv'),
    glue({path_to_data}, 'processed_expression_summary_scer_PROTEIN.tsv')
  )
)

# select dataset for analysis
data_tag <- "scer_prot" 

```


## Read in the data

```{r, message=FALSE}

# get relevant file names for data set of interest
data_key %>% 
  filter(set == data_tag) -> analysis_files

# read in data
meta_df <- read_tsv(analysis_files$meta_file)

exp_df <- read_tsv(analysis_files$expression_file)

exp_sum_df <- read_tsv(analysis_files$summary_file)

```


## Explore the relationship between conditions

```{r, message=FALSE}

# get pearson's correlation coefficient for gene expression between all conditions
if (data_tag %in% c("ecoli_full", "ecoli_sparse")) {
  cond_cor_mat <- exp_df %>% 
    select(-`log-TPM`) %>% 
    cor(., method = "pearson")
} else {
  cond_cor_mat <- exp_df %>% 
    select(-`Gene`) %>% 
    cor(., method = "pearson")
}

dim(cond_cor_mat)
cond_cor_mat[1:4, 1:4]

```


```{r, message=FALSE}

# make heatmap for correlations across conditions
fig_exp_cond_corr <- pheatmap::pheatmap(
  cond_cor_mat^2, # visualize R^2 instead of Pearson's corr
  color = inferno(100),
  cellheight = 10, #2 for ecoli_full, 6 for ecoli_sparse, 10 for scer_rna, ecoli_prot, and scer_prot
  cellwidth = 10, #2,
  border_color = NA,
  show_rownames = FALSE,
  show_colnames = FALSE,
  clustering_method = "average"
)

#fig_exp_cond_corr

```


```{r, message=FALSE, include=FALSE, eval=FALSE}

# visualize expression across conditions for each gene
fig_cond_gene_exp <- pheatmap::pheatmap(
  exp_df[, -1],
  color = inferno(100),
  show_rownames = FALSE,
  show_colnames = FALSE,
  clustering_method = "average"
)

#fig_cond_gene_exp

```


#### Example scatterplots of two highly correlated conditions

```{r, message=FALSE}

# find max pearson's r value between two conditions
test_mat <- cond_cor_mat
diag(test_mat) <- 0 # exclude self correlations
inds <- which(test_mat == max(test_mat), arr.ind = TRUE)

#cond_cor_mat[inds[1], inds[2]]
#rownames(inds) # "ytf__delydcI_ph5" "ytf__wt_ph5"
#exp_df[, inds[1]+1]
#exp_df[, inds[2]+1]

max_cond_corr_df <- tibble(
  exp_df[, inds[1]+1],
  exp_df[, inds[2]+1]
)
max_names <- colnames(max_cond_corr_df)
colnames(max_cond_corr_df) <- c("cond1", "cond2")

# store R^2 value for use in plot
if (data_tag %in% c("ecoli_full", "ecoli_sparse")) {
  r2_max_text <- data.frame(
  label = glue(
    '*R*<sup>2</sup> = {round(cond_cor_mat[inds[1], inds[2]]*
    cond_cor_mat[inds[1], inds[2]], 3)}'),
  x = 3, 
  y = 13.5
)
} else if (data_tag == "ecoli_prot") {
  r2_max_text <- data.frame(
  label = glue(
    '*R*<sup>2</sup> = {round(cond_cor_mat[inds[1], inds[2]]*
    cond_cor_mat[inds[1], inds[2]], 3)}'),
  x = -2, 
  y = 3.5 
)
} else if (data_tag == "scer_prot") {
  r2_max_text <- data.frame(
  label = glue(
    '*R*<sup>2</sup> = {round(cond_cor_mat[inds[1], inds[2]]*
    cond_cor_mat[inds[1], inds[2]], 3)}'),
  x = -4, 
  y = 7 
)
} else {
  r2_max_text <- data.frame(
    label = glue(
      '*R*<sup>2</sup> = {round(cond_cor_mat[inds[1], inds[2]]*
      cond_cor_mat[inds[1], inds[2]], 3)}'
    ),
    x = 3.5,
    y = 9
  )
}

# visualize two conditions with largest correlation
if (data_tag %in% c("ecoli_full", "ecoli_sparse")) {
  fig_max <- max_cond_corr_df %>% 
    ggplot(aes(x = cond1, y = cond2)) +
      geom_point(color = "black", alpha = 0.3) +
      scale_x_continuous(
        limits = cc(0, 15),
        expand = c(0.01, 0.01),
        name = glue('Condition {inds[1]} (log TPM)')
      ) +
    scale_y_continuous(
      limits = c(0, 15), 
      expand = c(0.02, 0.02),
      name = glue('Condition {inds[2]} (log TPM)')
    ) +
    #coord_fixed() +
    geom_richtext(
      data = r2_max_text,
      aes(x = x, y = y,label = label),
      label.color = NA,
      inherit.aes = FALSE
    ) +
    theme_half_open() +
    background_grid()
} else if (data_tag %in% c("ecoli_prot", "scer_prot")) {
  fig_max <- max_cond_corr_df %>% 
    ggplot(aes(x = cond1, y = cond2)) +
      geom_point(color = "black", alpha = 0.3) +
      scale_x_continuous(
        #limits = c(0, 5), 
        #expand = c(0.01, 0.01),
        name = glue('Condition {inds[1]}')
        # name = glue('Condition {inds[1]}: {max_names[1]}')
      ) +
      scale_y_continuous(
        #limits = c(0, 5),
        #expand = c(0.02, 0.02),
        name = glue('Condition {inds[2]}')
        # name = glue('Condition {inds[2]}: {max_names[2]}')
      ) +
      #coord_fixed() +
      geom_richtext(
        data = r2_max_text,
        aes(x = x, y = y,label = label),
        label.color = NA,
        inherit.aes = FALSE
      ) +
      theme_half_open() +
      background_grid()
} else {
  fig_max <- max_cond_corr_df %>% 
    ggplot(aes(x = cond1, y = cond2)) +
      geom_point(color = "black", alpha = 0.3) +
      scale_x_continuous(
        limits = c(2.5, 10), 
        expand = c(0.01, 0.01),
        name = glue('Condition {inds[1]} (log TPM)')
      ) +
      scale_y_continuous(
        limits = c(2.5, 10),
        expand = c(0.02, 0.02),
        name = glue('Condition {inds[2]} (log TPM)')
      ) +
      #coord_fixed() +
      geom_richtext(
        data = r2_max_text,
        aes(x = x, y = y,label = label),
        label.color = NA,
        inherit.aes = FALSE
      ) +
      theme_half_open() +
      background_grid()
}
#fig_max

```


#### Example scatterplots of two minimally correlated conditions

```{r, message=FALSE}

# find min pearson's r value between two conditions
inds_min <- which(cond_cor_mat == min(cond_cor_mat), arr.ind = TRUE)
#cond_cor_mat[inds_min[1], inds_min[2]]
#rownames(inds_min) # "ica__cytd_rib"    "ssw__glc_xyl_glc"

min_cond_corr_df <- tibble(
  exp_df[, inds_min[1]+1],
  exp_df[, inds_min[2]+1]
)
min_names <- colnames(min_cond_corr_df)
colnames(min_cond_corr_df) <- c("cond1", "cond2") # rename for easier reproducibility

# store R^2 value for use in plot
if (data_tag %in% c("ecoli_full", "ecoli_sparse")) {
  r2_min_text <- data.frame(
    label = glue(
      '*R*<sup>2</sup> = {round(cond_cor_mat[inds_min[1], inds_min[2]]*
      cond_cor_mat[inds_min[1], inds_min[2]], 3)}'
    ),
    x = 3,
    y = 13.5
  )
} else if (data_tag == "ecoli_prot") {
  r2_min_text <- data.frame(
  label = glue(
    '*R*<sup>2</sup> = {round(cond_cor_mat[inds_min[1], inds_min[2]]*
    cond_cor_mat[inds[1], inds[2]], 3)}'),
  x = -2, 
  y = 3.5 
)
} else if (data_tag == "scer_prot") {
  r2_min_text <- data.frame(
  label = glue(
    '*R*<sup>2</sup> = {round(cond_cor_mat[inds[1], inds_min[2]]*
    cond_cor_mat[inds[1], inds[2]], 3)}'),
  x = -4, 
  y = 7 
)
} else {
  r2_min_text <- data.frame(
    label = glue(
      '*R*<sup>2</sup> = {round(cond_cor_mat[inds_min[1], inds_min[2]]*
      cond_cor_mat[inds_min[1], inds_min[2]], 3)}'
    ),
    x = 3.5,
    y = 9
  )
}

# visualize the conditions with the smallest correlation
if (data_tag %in% c("ecoli_full", "ecoli_sparse")) {
  fig_min <- min_cond_corr_df %>% 
    ggplot(aes(x = cond1, y = cond2)) +
    geom_point(color = "black", alpha = 0.3) +
    scale_x_continuous(
      limits = c(0, 15),
      expand = c(0.01, 0.01),
      name = glue('Condition {inds_min[1]} (log TPM)')
    ) +
    scale_y_continuous(
      limits = c(0, 15),
      expand = c(0.02, 0.02),
      name = glue('Condition {inds_min[2]} (log TPM)')
    ) +
    #coord_fixed() +
    geom_richtext(
      data = r2_min_text,
      aes(x = x, y = y,label = label),
      label.color = NA,
      inherit.aes = FALSE
    ) +
    theme_half_open() +
    background_grid()
} else if (data_tag %in% c("ecoli_prot", "scer_prot")) {
  fig_min <- min_cond_corr_df %>% 
    ggplot(aes(x = cond1, y = cond2)) +
    geom_point(color = "black", alpha = 0.3) +
    scale_x_continuous(
      #limits = c(0, 5),
      #expand = c(0.01, 0.01),
      name = glue('Condition {inds_min[1]}')
      # name = glue('Condition {inds_min[1]}: {min_names[1]}')
    ) +
    scale_y_continuous(
      #limits = c(0, 5),
      #expand = c(0.02, 0.02),
      name = glue('Condition {inds_min[2]}')
      # name = glue('Condition {inds_min[2]}: {min_names[2]}')
    ) +
    #coord_fixed() +
    geom_richtext(
      data = r2_min_text,
      aes(x = x, y = y,label = label),
      label.color = NA,
      inherit.aes = FALSE
    ) +
    theme_half_open() +
    background_grid()
} else {
    fig_min <- min_cond_corr_df %>% 
    ggplot(aes(x = cond1, y = cond2)) +
      geom_point(color = "black", alpha = 0.3) +
      scale_x_continuous(
        limits = c(2.5, 10), 
        expand = c(0.01, 0.01),
        name = glue('Condition {inds_min[1]} (log TPM)')
      ) +
      scale_y_continuous(
        limits = c(2.5, 10),
        expand = c(0.02, 0.02),
        name = glue('Condition {inds_min[2]} (log TPM)')
      ) +
      #coord_fixed() +
      geom_richtext(
        data = r2_min_text,
        aes(x = x, y = y,label = label),
        label.color = NA,
        inherit.aes = FALSE
      ) +
      theme_half_open() +
      background_grid()
}

#fig_min

```


### Figure 2 
```{r, message=FALSE}

# combine figures for subplot b
fig_2b <- plot_grid(fig_max, fig_min, nrow = 2)

# combine all figures
fig_2 <- plot_grid(
  fig_exp_cond_corr[[4]], fig_2b, 
  nrow = 1,
  labels = "AUTO",
  scale = c(1, 0.85)
  # align = "h",
  # axis = "l"
)

fig_2

```


```{r, include=FALSE, eval=FALSE}

# needs white background due to transparency of heatmap and outer rectangle
fig_2_fixed <- cowplot::ggdraw(fig_2) + 
  theme(plot.background = element_rect(fill="white", color = NA))

# save plot
save_plot(
  file.path(
    path_to_figures, 
    'mackenzie', 
    glue('fig_corr_{data_tag}.png')   # file name
  ),
  fig_2_fixed, 
  ncol = 1, 
  nrow = 1, 
  base_height = 5.21, #base_height = 5.71,
  base_asp = 1.618, 
  base_width = NULL
)

```


```{r, message=FALSE, include=FALSE}

# remove intermediate plots from memory
rm(fig_exp_cond_corr, #fig_cond_gene_exp, 
   fig_max, fig_min, fig_2b, fig_2)

# remove unneccessary data frames and values
rm(max_cond_corr_df, min_cond_corr_df, 
   r2_max_text, r2_min_text, test_mat,
   inds, inds_min, max_names, min_names)

```


#### Gene expression vs various dispersion metrics

```{r, message=FALSE}

# calculate mean expression and dispersion metrics
if (data_tag %in% c("ecoli_full", "ecoli_sparse")) {
  exp_metrics <- exp_df %>% 
    rowwise() %>% 
    mutate(
      exp_mean = mean(c_across(fur__wt_fe:efeU__menFentCubiC_ale38)),
      exp_sd = sd(c_across(fur__wt_fe:efeU__menFentCubiC_ale38))
    ) %>% 
    select(`log-TPM`, exp_mean, exp_sd) %>%
    mutate(exp_cv = exp_sd/exp_mean)
  colnames(exp_metrics) <- c("gene", "exp_mean", "exp_sd", "exp_cv")
}


# calculate correlation of relationship between metrics
spear_rho_sd <- cor(
  exp_metrics$exp_mean, exp_metrics$exp_sd, 
  method = "spearman"
)
spear_rho_cv <- cor(
  exp_metrics$exp_mean, exp_metrics$exp_cv, 
  method = "spearman"
)

# visualize expression vs standard dev
exp_metrics %>% 
  ggplot(aes(x = exp_mean, y = exp_sd)) +
  geom_point(alpha = 0.5) +
  scale_x_continuous(name = "Expression mean") +
  scale_y_continuous(name = "Standard deviation") +
  labs(title = glue("Spearman's &rho; = {round(spear_rho_sd,4)}")) +
  theme_bw() +
  theme(plot.title = element_markdown())

```

```{r, message=FALSE}

# visualize expression vs coeff of var
exp_metrics %>% 
  ggplot(aes(x = exp_mean, y = exp_cv)) +
  geom_point(alpha = 0.5) +
  scale_x_continuous(name = "Expression mean") +
  scale_y_continuous(name = "Coefficient of variation") +
  labs(title = glue("Spearman's &rho; = {round(spear_rho_cv,4)}")) +
  theme_bw() +
  theme(plot.title = element_markdown())

```


## Explore growth rate data

```{r, message=FALSE}

meta_df %>% 
  ggplot(aes(x = `Growth Rate (1/hr)`)) +
  geom_histogram(binwidth = 0.05) +
  scale_x_continuous(
    limits = c(0, 1.5),
    expand = c(0,0)
  ) +
  scale_y_continuous(
    name = "Count", 
    expand = c(0,0)
  ) +
  theme_minimal_hgrid()

# slowest rate
slow_rate <- min(meta_df$`Growth Rate (1/hr)`)
# fastest rate
fast_rate <- max(meta_df$`Growth Rate (1/hr)`)
# slowest dt
slow_dt <- log(2)/slow_rate
# fastest dt
fast_dt <- log(2)/fast_rate

```

- Slowest rate: `r slow_rate`
- Fastest rate: `r fast_rate`
- Slowest doubling time: `r slow_dt`
- Fastest doubling time: `r fast_dt`

#### Assess individual gene correlations with the growth rate data

I'm only doing a single randomization/permutation here, and it should of course be noted that this randomization is a bit unfair since it destroys the underlying correlation structure between conditions. However, a permutation strategy that accounts for that structure would be very difficult and the only point here is to show that there are some genes that are more/less correlated with growth than you might expect by chance alone.

```{r, message=FALSE}



```


#### Finding representative examples of genes

```{r}

```



## Expression vs growth correlation

```{r, message=FALSE}

if (data_tag %in% c("ecoli_full", "ecoli_sparse")) {
  exp_gr_df <- exp_df %>% 
    gather(-`log-TPM`,
           key = "condition",
           value = "expression") %>% 
    spread(`log-TPM`, expression)
} else {
  exp_gr_df <- exp_df %>% 
    gather(-Gene,
           key = "condition",
           value = "expression") %>% 
    spread(Gene, expression)
}

exp_gr_df <- meta_df %>% 
    select(`Simple_sample_id`, `Growth Rate (1/hr)`) %>% 
    inner_join(., exp_gr_df, by = c("Simple_sample_id" = "condition"))

if (data_tag %in% c("ecoli_full", "ecoli_sparse", "ecoli_prot", "scer_rna", "scer_prot")) {  
  exp_gr_corr <- cor(exp_gr_df[2], exp_gr_df[3:ncol(exp_gr_df)], method = "pearson") %>% 
    as_tibble() %>% 
    gather(
      .,
      key = "genes",
      value = "pearsons"
    ) %>% 
    mutate(r2 = pearsons^2)
  
  perm_mat <- lapply(exp_gr_df[3:ncol(exp_gr_df)], sample) %>% as_tibble()
  exp_gr_perm <- cor(exp_gr_df[2], perm_mat, method = "pearson") %>% 
    as_tibble() %>% 
    gather(
      .,
      key = "genes",
      value = "pearsons"
    ) %>% 
    mutate(r2 = pearsons^2)
  
  perm_df <- tibble(
    exp_gr_corr$pearsons,
    exp_gr_perm$pearsons
  ) %>% 
    gather(., "set", "pearsons")
}

exp_gr_corr%>% filter(pearsons == max(pearsons)) %>% .$genes
exp_gr_corr%>% filter(pearsons == min(pearsons)) %>% .$genes

if (data_tag == "ecoli_full") {
  fig_ant_cor <- exp_gr_df %>% 
    ggplot(aes(x = b4658_2, y = `Growth Rate (1/hr)`)) +
      geom_point(alpha = 0.75) +
      scale_x_continuous("Expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = "b4658_2")
  
  fig_pos_cor <- exp_gr_df %>% 
    ggplot(aes(x = b2780, y = `Growth Rate (1/hr)`)) +
      geom_point(alpha = 0.75) +
      scale_x_continuous("Expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = "b2780")
} else if (data_tag == "ecoli_sparse") {
  fig_ant_cor <- exp_gr_df %>% 
    ggplot(aes(x = b3586, y = `Growth Rate (1/hr)`)) +
      geom_point(alpha = 0.75) +
      scale_x_continuous("Expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = "b3586")
  
  fig_pos_cor <- exp_gr_df %>% 
    ggplot(aes(x = b0170, y = `Growth Rate (1/hr)`)) +
      geom_point(alpha = 0.75) +
      scale_x_continuous("Expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = "b0170")
} else if (data_tag == "ecoli_prot") {
  fig_ant_cor <- exp_gr_df %>% 
    ggplot(aes(x = livJ, y = `Growth Rate (1/hr)`)) +
      geom_point(alpha = 0.75) +
      scale_x_continuous("Expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = "livJ")
  
  fig_pos_cor <- exp_gr_df %>% 
    ggplot(aes(x = kbl, y = `Growth Rate (1/hr)`)) +
      geom_point(alpha = 0.75) +
      scale_x_continuous("Expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = "kbl")
} else if (data_tag == "scer_rna") {
  fig_ant_cor <- exp_gr_df %>% 
    ggplot(aes(x = INM2, y = `Growth Rate (1/hr)`)) +
      geom_point(alpha = 0.75) +
      scale_x_continuous("Expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = "INM2")
  
  fig_pos_cor <- exp_gr_df %>% 
    ggplot(aes(x = GLN4, y = `Growth Rate (1/hr)`)) +
      geom_point(alpha = 0.75) +
      scale_x_continuous("Expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = "GLN4")
} else {
  fig_ant_cor <- exp_gr_df %>% 
    ggplot(aes(x = URA10, y = `Growth Rate (1/hr)`)) +
      geom_point(alpha = 0.75) +
      scale_x_continuous("Expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = "URA10")
  
  fig_pos_cor <- exp_gr_df %>% 
    ggplot(aes(x = RPS9A, y = `Growth Rate (1/hr)`)) +
      geom_point(alpha = 0.75) +
      scale_x_continuous("Expression (log TPM)") +
      theme_minimal_grid() +
      labs(title = "RPS9A")
}

fig_perm <- perm_df %>% 
  ggplot() +
    aes(x = pearsons, fill = set) +
    geom_histogram(alpha = 0.5) +
    scale_x_continuous(name = "Pearson's r") +
    scale_y_continuous(name = "Counts") +
    scale_fill_discrete(labels = c("True data", "Shuffled data")) +
    theme_minimal_grid() +
    theme(legend.position = "top")



```


## Figure 4:
```{r, include=FALSE, eval=FALSE}

fig_4 <- plot_grid(
  fig_ant_cor, fig_pos_cor, fig_perm,
  nrow = 1,
  labels = "AUTO"
) + 
  theme(plot.background = element_rect(fill="white", color = NA))

save_plot(
  file.path(
    path_to_figures, 
    'mackenzie', 
    glue('fig_gene_con_{data_tag}.png')   # file name
  ),
  fig_4, 
  ncol = 1, 
  nrow = 1, 
  base_height = 6.71, #base_height = 5.71,
  base_asp = 1.618, 
  base_width = NULL
)

```


